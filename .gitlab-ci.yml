stages:
  - install
  - build
  - triggers

install_deps:
  tags:
    - kube-build
  stage: install
  image: reg.1cb.kz/dockerhub/library/node:16.17.1-alpine3.15
  artifacts:
    paths:
      - node_modules
    expire_in: 15 minute
  script:
    - npm i
    - ls -a
  cache:
    key: node_modules
    paths:
      - node_modules

.base_build: &base_build
  image: reg.1cb.kz/dockerhub/library/node:16.17.1-alpine3.15
  artifacts:
    expire_in: 5 minute
#    paths:
#      - ./build

build:dev:
  tags:
    - kube-build
  only:
    - /^lerna-.*/
  <<: *base_build
  stage: build
  environment:
    name: kyc-staging
  variables:
    CONTAINER_TAGGED_IMAGE: $HR_REGISTRY/$CI_PROJECT_NAME-$CI_PROJECT_ID/$CI_PROJECT_NAME:$CI_ENVIRONMENT_SLUG-$CI_PIPELINE_ID
  script:
    - npm run build
    - ls -a

trigger_main:
  stage: triggers
  trigger:
    include: packages/main/.gitlab-ci.yml
  only:
    changes:
      - "packages/main/**/*"
    refs:
      - /^lerna-.*/
#  script:
#    - ls -a
#    - cat node_modules
#    - cat packages/main/build
#  needs:
#    - project: packages/main/
#      job: install_deps
#      ref: /lerna^/
#      artifacts: true
