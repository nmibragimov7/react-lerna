stages:
  - install
  - build
  - triggers

install_deps:
  tags:
    - kube-build
  stage: install
  image: reg.1cb.kz/dockerhub/library/node:16.17.1-alpine3.15
  artifacts:
    paths:
      - node_modules
    expire_in: 15 minute
  script:
    - npm i

.base_build: &base_build
  image: reg.1cb.kz/dockerhub/library/node:16.17.1-alpine3.15
  artifacts:
    expire_in: 5 minute
    paths:
      - ./packages/main/build
      - ./packages/client/dist

build:dev:
  tags:
    - kube-build
  only:
    - lerna
  <<: *base_build
  stage: build
  environment:
    name: kyc-staging
  variables:
    CONTAINER_TAGGED_IMAGE_MAIN: $HR_REGISTRY/$CI_PROJECT_NAME-$CI_PROJECT_ID/$CI_PROJECT_NAME:$CI_ENVIRONMENT_SLUG-$CI_PIPELINE_ID_MAIN
    CONTAINER_TAGGED_IMAGE_CLIENT: $HR_REGISTRY/$CI_PROJECT_NAME-$CI_PROJECT_ID/$CI_PROJECT_NAME:$CI_ENVIRONMENT_SLUG-$CI_PIPELINE_ID_CLIENT
  script:
    - npm run build
    - ls packages/main

trigger_main:
  stage: triggers
  trigger:
    include: packages/main/.gitlab-ci.yml
  only:
    changes:
      - "packages/main/**/*"
    refs:
      - lerna

trigger_client:
  stage: triggers
  trigger:
    include: packages/client/.gitlab-ci.yml
  only:
    changes:
      - "packages/client/**/*"
    refs:
      - lerna
